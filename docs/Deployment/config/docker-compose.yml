# AFC Odoo + N8N Production Docker Compose
# Version: 1.0
# Last Updated: 2025-01
#
# Usage:
#   1. Copy this file to /opt/afc-n8n-deployment/
#   2. Create .env file with required variables
#   3. Run: docker-compose up -d
#
# Required .env variables:
#   POSTGRES_USER, POSTGRES_ROOT_PASSWORD, POSTGRES_DB
#   POSTGRES_NON_ROOT_USER, POSTGRES_NON_ROOT_PASSWORD
#   N8N_ENCRYPTION_KEY, REDIS_PASSWORD
#   N8N_HOST, N8N_PORT, N8N_PROTOCOL, WEBHOOK_URL

version: '3.8'

services:
  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    image: postgres:16-alpine
    container_name: afc-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_ROOT_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-n8n_production}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    networks:
      - afc_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-n8n_production}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # ===========================================
  # Redis Queue Manager
  # ===========================================
  redis:
    image: redis:6-alpine
    container_name: afc-redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - afc_network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # ===========================================
  # N8N Main Instance
  # ===========================================
  n8n:
    image: docker.n8n.io/n8nio/n8n:2.1.4
    container_name: afc-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      # Database Configuration
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB:-n8n_production}
      - DB_POSTGRESDB_USER=${POSTGRES_NON_ROOT_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_NON_ROOT_PASSWORD}

      # N8N Core Configuration
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=${N8N_PORT:-5678}
      - N8N_PROTOCOL=${N8N_PROTOCOL:-https}
      - WEBHOOK_URL=${WEBHOOK_URL:-https://localhost:5678/}

      # Timezone (Philippines)
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-Asia/Manila}
      - TZ=${TZ:-Asia/Manila}

      # Queue Configuration (for distributed execution)
      - EXECUTIONS_MODE=${EXECUTIONS_MODE:-queue}
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD}

      # Security
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}

      # Execution Settings
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_ON_PROGRESS=true
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true

      # Logging
      - N8N_LOG_LEVEL=info
      - N8N_LOG_OUTPUT=console

    volumes:
      - n8n_data:/home/node/.n8n
      - ./workflows:/home/node/workflows:ro
    networks:
      - afc_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ===========================================
  # N8N Worker (for queue processing)
  # ===========================================
  n8n-worker:
    image: docker.n8n.io/n8nio/n8n:2.1.4
    container_name: afc-n8n-worker
    restart: unless-stopped
    command: worker
    environment:
      # Database Configuration
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB:-n8n_production}
      - DB_POSTGRESDB_USER=${POSTGRES_NON_ROOT_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_NON_ROOT_PASSWORD}

      # N8N Core Configuration
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      # Timezone
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-Asia/Manila}
      - TZ=${TZ:-Asia/Manila}

      # Queue Configuration
      - EXECUTIONS_MODE=${EXECUTIONS_MODE:-queue}
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD}

      # Worker Settings
      - QUEUE_HEALTH_CHECK_ACTIVE=true
      - QUEUE_WORKER_TIMEOUT=60

    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - afc_network
    depends_on:
      - n8n
      - redis
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

# ===========================================
# Volumes
# ===========================================
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/afc-n8n-deployment/data/postgres
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/afc-n8n-deployment/data/redis
  n8n_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/afc-n8n-deployment/data/n8n

# ===========================================
# Networks
# ===========================================
networks:
  afc_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
